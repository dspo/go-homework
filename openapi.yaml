# OpenAPI 3.0 specification for
openapi: 3.0.0
info:
  title: Sample API
  description: |-
    # 权限

    ## admin

    在系统初始化时,应当创建出 admin 用户:

    - 用户名: admin
    - 初始密码: adminadmin

    admin 用户拥有超然的权限,能查询和操作所有资源。
    例外:
    - admin User 不能删除自身。
    - admin User 不能解绑自身的 admin Role。

    ## Role

    本系统中 Role 无实际判定权限的作用,仅作为一个维表资源而设计。可以说无实际含义。
    系统初始化时应当初始化 3 个 System Roles(见相关接口的描述)。

    `admin` Role 与 `admin` User 是紧紧绑定的,admin User 初始化时必须绑定 admin Role,且永远不能解绑。
    admin User 可以绑定或解绑其他 Roles。

    ## 用户对用户的可见性

    **当两个用户同处于一个 Team,则两用户互相可见。**
    比如 user::A in [team::a, team::b], user::B in {team::b, team::c}, user::C in {team::c, team::D}.
    那么 user::A 与 user::B 同处于 team::b, 则 user::A 与 user::B 互相可见。
    user::A 与 user::C 不同处于任何 Team,则 user::A 与 user::C 互相不可见。
    那么 user::A 访问 `/api/users` 这样的接口时,接口返回的 users 列表只能包含 {user::B}, 而不能包含 {user::C}.

    **用户对自己总是可见的。**
    用户能查询到自己。

    用户可见性会影响一些接口逻辑:
    - 如果接口返回 users 列表,那么列表中不应当包含 Me 不可见的那部分 users（但应当包含自身，因为用户可见自己）。
    - Me 没有权限查询不可见的 User 的详情。

    ## Team Leader

    Admin 可以标记普通用户为 Team Leader。
    一个 Team 可以没有 Team Leader, 最多只能有一个 Team Leader。
    Team 的 Leader 可以被更换,Admin 和现任 Team Leader 可以执行此操作。(见`PATCH #/api/teams/{team_id}`)
    Leader 可以读写其 Team 及该 Team 下的子资源(主要是 projects)。
    一个 User 可以作为多个 Team 的 Leader。

    ## Me

    本文档中用 Me 表示发送请求的当前 User。

  version: 1.0.0
  license:
    name: MIT
    url: https://mit-license.org/
servers:
  - url: https://localhost:8080
    description: Production server
security:
  - cookieAuth: []
paths:
  /healthz:
    get:
      tags: [System]
      operationId: healthz
      summary: 健康检查
      description: 返回 200 OK 即表示服务已准备好。
      security: []
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"

  /api/audits:
    get:
      tags: [Audits]
      operationId: audits
      summary: 查询审计记录
      description: |-
        审计日志的格式由开发者自行实现。
        一般来说,应当记录 谁 什么时间 做了什么操作 结果如何。
        敏感操作如修改密码、增删改资源等,应当被审计日志记录。
        其他操作由开发者自行决定是否需要记录审计日志。
        但不应当所有操作都记录审计日志。

        权限:
        - 仅 admin 用户可以查询审计日志。
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - $ref: "#/components/parameters/keyword"
        - $ref: "#/components/parameters/start_at"
        - $ref: "#/components/parameters/end_at"
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      type: object
                      required:
                        - id
                        - content
                        - created_at
                      properties:
                        id:
                          $ref: "#/components/schemas/id"
                        content:
                          type: string
                        created_at:
                          $ref: "#/components/schemas/timestamp"
                      additionalProperties: false
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"

  /api/login:
    post:
      operationId: login
      tags:
        - Me
      summary: 用户登录
      description: |-
        用户正确登录后,应当通过 Set-Cookie 返回登录相关凭证。
        客户端后续取用 Cookie 对其他接口进行访问。

        **首次登录限制:**
        - 使用初始密码首次登录后,用户必须先修改密码才能访问其他受保护的接口。
        - 在修改密码前访问其他接口将返回 403 错误,提示需要修改密码。
        - 这一限制适用于所有用户,包括 admin 用户。
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  title: LoginWithUsername
                  required: [username, password]
                  properties:
                    username:
                      $ref: "#/components/schemas/username"
                    password:
                      $ref: "#/components/schemas/password"
                  additionalProperties: false
                - type: object
                  title: LoginWithEmail
                  required: [email, password]
                  properties:
                    email:
                      $ref: "#/components/schemas/email"
                    password:
                      $ref: "#/components/schemas/password"
                  additionalProperties: false
            example: { "username": "HuaYi", "password": "my_password" }
      responses:
        200:
          description: OK - 登录成功
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        default:
          $ref: "#/components/responses/default"
  /api/logout:
    post:
      operationId: logout
      tags:
        - Me
      summary: 用户登出
      description: |-
        用户登出后,会话应当失效。
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default: { $ref: "#/components/responses/default" }
  /api/me:
    get:
      operationId: me
      tags:
        - Me
      summary: 查询 Me 信息
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"

    put:
      operationId: updateMe
      tags:
        - Me
      summary: me 修改自身信息
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  $ref: "#/components/schemas/User/properties/email"
                nickname:
                  $ref: "#/components/schemas/User/properties/nickname"
                logo:
                  $ref: "#/components/schemas/User/properties/logo"
              additionalProperties: false
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        400: { $ref: "#/components/responses/default" }
        default: { $ref: "#/components/responses/default" }

  /api/me/password:
    put:
      operationId: updateMyPassword
      tags:
        - Me
      summary: 用户修改自身密码
      description: |-
        用户修改密码后,当前会话将立即失效,需要使用新密码重新登录。
        这是一项安全措施,确保密码修改后旧的会话凭证不再有效。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                old_password:
                  $ref: "#/components/schemas/password"
                new_password:
                  $ref: "#/components/schemas/password"
              additionalProperties: false
      responses:
        200:
          description: Success
        400: { $ref: "#/components/responses/default" }
        default: { $ref: "#/components/responses/default" }
  /api/me/teams:
    get:
      operationId: getMyTeams
      tags:
        - Me
      summary: 查询用户本人加入的 teams 列表
      parameters:
        - name: leading
          description: |-
            筛选本人作为 Leader 的 teams。
            传 true 则仅返回本人作为 Leader 的 teams。
            传 false 则仅返回本人未作为 Leader 的 teams。
            不传则返回本人参与的所有 teams。
          in: query
          schema:
            type: boolean
          required: false
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                  - type: object
                    properties:
                      list:
                        type: array
                        items:
                          $ref: "#/components/schemas/Team"
        400: { $ref: "#/components/responses/default" }
        default: { $ref: "#/components/responses/default" }
  /api/me/teams/{team_id}:
    parameters:
      - in: path
        name: team_id
        schema:
          type: integer
        required: true
    delete:
      tags:
        - Me
      operationId: exitTeam
      summary: Me 主动退出 Team
      description: |-
        - 如果 Me 是该 Team 的 Leader，退出后 Leader 职位将被清空，该 Team 将无 Leader。
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/me/projects:
    get:
      tags:
        - Me
      summary: 查询本人参与的 projects 列表
      description: |-
        示例:
        /api/me/projects?team_id=1&team_id=2
      operationId: getMyProjects
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - $ref: "#/components/parameters/search_project_name"
        - in: query
          name: team_id
          description: 按 team_id 筛选，可多传，仅返回指定 Team 下的 Projects
          schema:
            type: array
            items:
              type: integer
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                  - type: object
                    properties:
                      list:
                        type: array
                        items:
                          $ref: "#/components/schemas/Project"
        400: { $ref: "#/components/responses/default" }
        default: { $ref: "#/components/responses/default" }

  /api/me/projects/{project_id}:
    parameters:
      - in: path
        name: project_id
        schema:
          type: integer
        required: true
    delete:
      tags:
        - Me
      operationId: exitProject
      summary: Me 主动退出 Project
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/users:
    post:
      tags:
        - Users
      summary: 为系统添加一名 user
      description: |-
        仅 admin 用户可以添加用户
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  $ref: "#/components/schemas/username"
                password:
                  $ref: "#/components/schemas/password"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        409:
          $ref: "#/components/responses/Conflict"
        default:
          $ref: "#/components/responses/default"
    get:
      tags:
        - Users
      summary: 查询用户列表
      description: |-
        - 当 me == admin, 可以查询所有 users 列表。
        - 当 me == 普通用户, 则查询可见的 users 列表。
      operationId: listUsers
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - $ref: "#/components/parameters/search_username"
        - in: query
          name: team_id
          description: |-
            - 该参数可以多传。
            - 该参数旨在用 team_id 筛选 users 列表。
          schema:
            type: array
            items:
              type: integer
          required: false
        - in: query
          name: role_name
          schema:
            type: array
            items:
              type: string
          description: |-
            - 该参数旨在用 role_name 筛选 users 列表。
            - 该参数可以多传。多传时表示“或”的关系。
          required: false
      responses:
        200:
          description: A JSON array of user names
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
        400: { $ref: "#/components/responses/default" }
        default: { $ref: "#/components/responses/default" }
  /api/users/{user_id}:
    parameters:
      - in: path
        name: user_id
        required: true
        schema:
          $ref: "#/components/schemas/id"
    get:
      tags:
        - Users
      operationId: getUser
      summary: 查询用户详情
      description: |-
        - 如果 me 与被查用户不同处于任何 Team,则无权限。
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"
    delete:
      tags:
        - Users
      summary: 删除用户
      description: |-
        - 仅 admin 用户可以删除普通用户
        - admin 用户不能被删除
      operationId: deleteUser
      responses:
        200:
          description: Success
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/users/{user_id}/teams:
    parameters:
      - in: path
        name: user_id
        required: true
        schema:
          type: integer
    get:
      tags:
        - Users
      summary: 查询用户加入的 Teams 列表
      description: |-
        权限说明：
        - 查询他人的 teams 列表时首先要满足可见性约束。
        - admin 用户可以查看所有 users 的所有 teams。
        - 普通用户仅能查看共同 Teams 下用户的 teams 列表。
        - 普通用户能查看其他用户的 teams 列表不应当超过 Me 自身的列表范围,比如 Me 所在的 teams 为 [a, b], user 所在的 teams 为 [a, c], 那么 Me 查询该接口仅返回 [a]。
      operationId: getUserTeams
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/Team"
        400: { $ref: "#/components/responses/default" }
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default: { $ref: "#/components/responses/default" }
  /api/users/{user_id}/projects:
    parameters:
      - in: path
        name: user_id
        required: true
        schema:
          type: integer
    get:
      operationId: getUserProjects
      tags:
        - Users
      summary: 查询用户参与的项目
      description: |-
        - admin 可以查看所有用户的所有参与项目的列表。
        - 普通用户仅可以查看同 Team 的用户参与的项目列表。
        - 普通用户能查看到的其他用户的 projects 列表范围不应当超出自身参与的 projects 范围。
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/Project"
        400: { $ref: "#/components/responses/default" }
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default: { $ref: "#/components/responses/default" }

  /api/users/{user_id}/roles:
    parameters:
      - in: path
        name: user_id
        required: true
        schema:
          type: integer
    post:
      tags:
        - Users
      operationId: addUserRole
      summary: 为用户添加角色
      description: |-
        - 仅 admin 可以为用户添加 Custom Role。
        - 不能添加 System Roles（admin、team leader、normal user），这些角色由系统自动管理。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role_id:
                  type: integer
                  description: 要添加的角色 ID
              required:
                - role_id
              additionalProperties: false
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/users/{user_id}/roles/{role_id}:
    parameters:
      - in: path
        name: user_id
        required: true
        schema:
          type: integer
      - in: path
        name: role_id
        required: true
        schema:
          type: integer
    delete:
      tags:
        - Users
      operationId: removeUserRole
      summary: 移除用户的角色
      description: |-
        - 仅 admin 可以移除用户的 Custom Role。
        - 不能移除 System Roles（admin、team leader、normal user），这些角色由系统自动管理。
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/teams:
    get:
      tags:
        - Teams
      summary: 查询所有 teams
      description: |-
        - admin: 查询所有 teams.
        - 普通用户: 同 `GET /api/me/teams`.
      operationId: listTeams
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/Team"
        400: { $ref: "#/components/responses/default" }
        default:
          $ref: "#/components/responses/default"

    post:
      tags:
        - Teams
      summary: 创建一个 Team
      description: |-
        - 仅 admin 可以创建 Team。
      operationId: createTeam
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  $ref: "#/components/schemas/Team/properties/name"
                desc:
                  $ref: "#/components/schemas/Team/properties/desc"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Team"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        409:
          $ref: "#/components/responses/Conflict"
        default:
          $ref: "#/components/responses/default"

  /api/teams/{team_id}:
    parameters:
      - in: path
        name: team_id
        required: true
        schema:
          type: integer
    get:
      operationId: getTeam
      tags:
        - Teams
      summary: 查询 Team 详情。
      description: |-
        - admin 可以查询所有 Team 的详情。
        - 普通用户仅能查询 Me 所参与的 Team 的详情。
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Team"
                properties:
                  projects:
                    type: array
                    items:
                      type: object
                      required:
                        - id
                        - name
                      properties:
                        id:
                          $ref: "#/components/schemas/Project/properties/id"
                        name:
                          $ref: "#/components/schemas/Project/properties/name"
                      additionalProperties: false
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    put:
      operationId: updateTeam
      tags:
        - Teams
      summary: 修改 Team 属性
      description: |-
        - admin 用户可以修改 Team 属性。
        - Team Leader 可以修改 Team 属性。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  $ref: "#/components/schemas/Team/properties/name"
                desc:
                  $ref: "#/components/schemas/Team/properties/desc"
              additionalProperties: false
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Team"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    patch:
      operationId: updateTeamLeader
      tags:
        - Teams
      summary: 仅用于修改 Team Leader
      description: |-
        - admin 可以修改 Team Leader。
        - 现任 Team Leader 可以修改 Team Leader 为 Team 下的其他 User。
        - Team 一开始可以没有 Leader。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                required:
                  - op
                  - path
                properties:
                  op:
                    type: string
                    enum: [replace]
                  path:
                    type: string
                    enum: [/leader]
                  value:
                    type: object
                    nullable: true
                    required:
                      - id
                    properties:
                      id:
                        $ref: "#/components/schemas/id"
                        description: 新的 Leader 的 User.Id, 传 null 则表示清空 Leader 职位。
                    additionalProperties: false
                additionalProperties: false
                minItems: 1
                maxItems: 1
            examples:
              重设 Leader:
                value:
                  [{ "op": "replace", "path": "/leader", "value": { "id": 5 } }]
              清空 Leader:
                value: [{ "op": "replace", "path": "/leader", "value": null }]

      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Team"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    delete:
      operationId: deleteTeam
      tags:
        - Teams
      summary: 删除 Team
      description: |-
        - admin 用户可以删除 Team。
        - Team Leader 可以删除 Team。
        - 删除 Team 会级联删除该 Team 下的所有 Projects，同时解除所有 User 与该 Team 及其 Projects 的关联，但不会删除这些 User。
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/teams/{team_id}/users:
    parameters:
      - in: path
        name: team_id
        required: true
        schema:
          $ref: "#/components/schemas/id"
    get:
      operationId: getTeamUsers
      tags:
        - Teams
      summary: 查询 Team 下成员列表
      description: |-
        - 继承父路径权限。
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - $ref: "#/components/parameters/search_username"
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
        400: { $ref: "#/components/responses/default" }
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    post:
      operationId: addTeamUser
      tags:
        - Teams
      summary: 为 Team 添加成员。
      description: |-
        - admin 可以为 Team 添加成员。
        - Team Leader 可以为 Team 添加成员。注意: 被添加的 User 应当是 Me 可见的。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
              properties:
                user_id:
                  $ref: "#/components/schemas/User/properties/id"
              additionalProperties: false
      responses:
        200:
          description: OK
        400: { $ref: "#/components/responses/default" }
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/teams/{team_id}/users/{user_id}:
    parameters:
      - in: path
        name: team_id
        required: true
        schema:
          type: integer
      - in: path
        name: user_id
        required: true
        schema:
          type: integer
    delete:
      tags:
        - Teams
      summary: 从 Team 中移除 User
      description: |-
        - admin 可以移除任何 Team 中的任何 User。
        - Team Leader 可以移除本 Team 中的任何 User(包括自身)。
        - 如果被移除的 User 是该 Team 的 Leader，移除后 Leader 职位将被清空，该 Team 将无 Leader。
      operationId: removeTeamUser
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/teams/{team_id}/projects:
    description: |-
      - Team 与 Project 是有层级关系的。一个 Team 下可以有多个 projects,一个 Project 必然属于且只能属于一个 Team。对 Team 和 Project 的操作应当注意它们互相之间的级联关系。
    parameters:
      - in: path
        name: team_id
        required: true
        schema:
          type: integer
    get:
      operationId: getTeamProjects
      tags:
        - Teams
      summary: 查询 Team 下的 projects 列表。
      description: |-
        - admin 可以查询任何 Team 下的所有 projects 列表。
        - 普通用户可以查询其所在 Team 下的所有 projects 列表。
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - $ref: "#/components/parameters/search_project_name"
        - $ref: "#/components/parameters/part_in"
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/Project"
        400: { $ref: "#/components/responses/default" }
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"
    post:
      tags:
        - Teams
      summary: 为 Team 添加一个 Project
      description: |-
        - admin 可以为任何 Team 添加 Project。
        - Team Leader 可以为本团队添加 Project。
        - 创建时 status 默认为 `WAIT_FOR_SCHEDULE`
      operationId: createTeamProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  $ref: "#/components/schemas/Project/properties/name"
                desc:
                  $ref: "#/components/schemas/Project/properties/desc"
              additionalProperties: false
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/projects/{project_id}:
    parameters:
      - name: project_id
        in: path
        required: true
        schema:
          $ref: "#/components/schemas/id"
    get:
      operationId: getProject
      tags:
        - Projects
      summary: 查询 Project 详情。
      description: |-
        - admin 可以查询所有 Project 详情。
        - Team Leader 可以查询其 Team 下所有 Project 详情。
        - 普通用户可以查询其参与了的 Project 的详情。
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    put:
      operationId: updateProject
      tags:
        - Projects
      summary: 更新 Project 信息
      description: |-
        - admin 可以更新任何 Project。
        - Team Leader 可以更新其 Team 下的 Project。
        - 普通用户无权限更新 Project。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  $ref: "#/components/schemas/Project/properties/name"
                desc:
                  $ref: "#/components/schemas/Project/properties/desc"
                status:
                  $ref: "#/components/schemas/Project/properties/status"
              additionalProperties: false
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    patch:
      operationId: patchProject
      tags:
        - Projects
      summary: 部分更新 Project 信息
      description: |-
        - admin 可以部分更新任何 Project。
        - Team Leader 可以部分更新其 Team 下的 Project。
        - 普通用户无权限更新 Project。
        - 使用 JSON Patch 格式进行部分更新。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                properties:
                  op:
                    type: string
                    enum: [replace]
                    description: 操作类型
                  path:
                    type: string
                    enum: [/status, /name, /desc]
                    description: 要修改的字段路径（符合 RFC 6902 标准）
                  value:
                    description: 新值
                    oneOf:
                      - type: string
                required:
                  - op
                  - path
                  - value
                additionalProperties: false
            example:
              - op: replace
                path: /status
                value: FINISHED
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    delete:
      operationId: deleteProject
      tags:
        - Projects
      summary: 删除 Project
      description: |-
        - admin 可以删除任何 Project。
        - Team Leader 可以删除其 Team 下的 Project。
        - 删除 Project 会自动解除所有参与该 Project 的 User 关联，但不会删除这些 User。
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/projects/{project_id}/users:
    parameters:
      - name: project_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Projects
      operationId: getProjectUsers
      summary: 查询 Project 参与人员列表
      description: |-
        - admin 可以查询任何 Project 的参与人员列表。
        - Team Leader 可以查询其 Team 下 Project 的参与人员列表。
        - 普通用户可以查询其参与的 Project 的参与人员列表。
      parameters:
        - $ref: "#/components/parameters/order_by"
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - $ref: "#/components/parameters/search_username"
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

    post:
      tags:
        - Projects
      operationId: addProjectUser
      summary: 为 Project 添加参与人员。
      description: |-
        - admin 可以为 Team 添加参与人员。
        - Team Leader 可以为 Team 下的 Project 添加参与人员。注意：被添加的 User 应当是 Me 可见的。
        - 如果 User 被添加到 Project 时还不是 Team 成员,则自动成为 Team 成员。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
              properties:
                user_id:
                  $ref: "#/components/schemas/id"
              additionalProperties: false
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/projects/{project_id}/users/{user_id}:
    parameters:
      - in: path
        name: project_id
        required: true
        schema:
          type: integer
      - in: path
        name: user_id
        required: true
        schema:
          type: integer
    delete:
      tags:
        - Projects
      operationId: removeProjectUser
      summary: 清退项目的参与者
      description: |-
        - admin 可以清退任何 Project 的参与者。
        - Team Leader 可以清退其 Team 下 Project 的参与者。
        - Project 与 User 无级联关系,从 Project 中清退 User 不会造成该 User 退出 Team, 更不会造成该 User 被删除。
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

  /api/roles:
    get:
      tags:
        - Roles
      operationId: listRoles
      summary: 查询所有 Roles
      description: |-
        Role 是全局维表, 所有用户都可以查询 Roles 列表。
        该资源列表不支持分页。
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                properties:
                  list:
                    type: array
                    items:
                      $ref: "#/components/schemas/Role"
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
    post:
      tags:
        - Roles
      operationId: createRole
      summary: 创建 Role
      description: |-
        - 系统初始化时,应当初始化内置 3 个 Roles:
          - {"id": 1, "type": "System", "name": "admin"} 有且仅有 admin 是此角色；
          - {"id": 2, "type": "System", "name": "team leader"} 当用户至少是一个 Team 的 Leader 时自动拥有此角色；
          - {"id": 3, "type": "System", "name": "normal user"} 每个用户至少有一个角色,当用户无其他角色时退化为此角色。
        - 只有 admin 可以创建 Role。后天创建的 Role 的 type 为 `Custom`。
        - Role 与 User 是多对多关系,即一个 User 可以有多个 Role,多个用户可以有同一个 Role。
        - Role 与 User 没有层级关系,删除 Role 资源要删除相关 User 的 Role 属性,但不会级联删除 User。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  $ref: "#/components/schemas/Role/properties/name"
                desc:
                  $ref: "#/components/schemas/Role/properties/desc"
              additionalProperties: false
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Role"
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        409:
          $ref: "#/components/responses/Conflict"
        default:
          $ref: "#/components/responses/default"
  /api/roles/{role_id}:
    parameters:
      - in: path
        name: role_id
        required: true
        schema:
          type: integer
    delete:
      tags:
        - Roles
      operationId: deleteRole
      summary: 删除 Role
      description: |-
        - 仅 admin 能删除 Role
        - 删除 Role 不会级联删除相关 User。
      responses:
        200:
          description: Success
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/NotFound"
        default:
          $ref: "#/components/responses/default"

components:
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: 描述错误信息
    User:
      type: object
      required:
        - id
        - username
        - roles
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          readOnly: true
        username:
          description: |-
            用户名,在系统内唯一。
          allOf:
            - $ref: "#/components/schemas/username"
            - readOnly: true
        email:
          $ref: "#/components/schemas/email"
        nickname:
          description: |-
            用户昵称（可选）。
            如果无昵称,则与 username 相同。
          type: string
        logo:
          description: 用户头像（可选）。是 base64 编码字符串或 URL。
          type: string
        roles:
          description: 用户的角色(可以含多个)
          type: array
          items:
            $ref: "#/components/schemas/Role"
        created_at:
          $ref: "#/components/schemas/timestamp"
        updated_at:
          $ref: "#/components/schemas/timestamp"
    Role:
      type: object
      required:
        - id
        - name
        - type
      properties:
        id:
          type: integer
        name:
          description: |-
            Role 名称，在系统内唯一。
          type: string
        type:
          type: string
          enum:
            - System
            - Custom
        desc:
          description: Role 描述（可选）
          type: string
    Team:
      type: object
      required:
        - id
        - name
        - created_at
        - updated_at
      properties:
        id:
          $ref: "#/components/schemas/id"
        name:
          description: |-
            Team 名称,在系统内唯一。
          type: string
        desc:
          description: Team 描述（可选）
          type: string
        leader:
          description: Team Leader（可选，Team 可以没有 Leader）
          $ref: "#/components/schemas/User"
        created_at:
          $ref: "#/components/schemas/timestamp"
        updated_at:
          $ref: "#/components/schemas/timestamp"
    Project:
      type: object
      required:
        - id
        - name
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: integer
        name:
          description: |-
            Project 名称，在同一 Team 内唯一。
          type: string
        desc:
          description: Project 描述（可选）
          type: string
        status:
          type: string
          enum: [WAIT_FOR_SCHEDULE, IN_PROGRESS, FINISHED]
          default: WAIT_FOR_SCHEDULE
        created_at:
          $ref: "#/components/schemas/timestamp"
        updated_at:
          $ref: "#/components/schemas/timestamp"
    ListResponse:
      type: object
      properties:
        total:
          type: integer
        list:
          type: array
      required: [total, list]
      additionalProperties: false
    id:
      type: integer
    username:
      description: 用户名，4-30个字符，只能包含字母、数字、下划线和连字符
      type: string
      pattern: "^[a-zA-Z0-9_-]{4,30}$"
    email:
      description: 电子邮件地址，必须符合标准邮箱格式
      type: string
      pattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    password:
      description: 密码，8-30个字符，只能包含字母、数字、下划线和连字符
      type: string
      pattern: "^[a-zA-Z0-9_-]{8,30}$"
    timestamp:
      description: Unix 时间戳（秒）
      type: integer
      format: int64
      example: 1763540621
  parameters:
    order_by:
      in: query
      name: order_by
      schema:
        type: string
        enum:
          - created_at
          - updated_at
      required: false
    page:
      in: query
      name: page
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
      description: 页码，从 1 开始
    page_size:
      in: query
      name: page_size
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: 每页数量，默认 20，最大 100
    keyword:
      in: query
      name: keyword
      required: false
      schema:
        type: string
    search_username:
      in: query
      name: name
      description: |-
        用 `username` 或 `nickname` 模糊搜索。
        注意: 当客户端传入该参数时,要对 `username` 和 `nickname` 都进行模糊搜索。
      required: false
      schema:
        type: string
    search_project_name:
      in: query
      name: name
      description: 用 project `name` 模糊搜索
      required: false
      schema:
        type: string
    part_in:
      in: query
      name: part_in
      description: |-
        `true`: 筛选 Me 参与的 projects
        `false`: 筛选 Me 未参与的 projects
        不传: 不作此项筛选
      schema:
        type: boolean
    start_at:
      in: query
      name: start_at
      required: false
      schema:
        $ref: "#/components/schemas/timestamp"
    end_at:
      in: query
      name: end_at
      required: false
      schema:
        $ref: "#/components/schemas/timestamp"
  responses:
    default:
      description: Error response
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Unauthorized - 用户未登录
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "未登录或会话已过期"
    Forbidden:
      description: Forbidden - 用户无权限执行此操作
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "无权限执行此操作"
    NotFound:
      description: Not Found - 请求的资源不存在
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "资源不存在"
    Conflict:
      description: Conflict - 资源冲突
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "资源已存在或存在冲突"
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
      description: Session cookie authentication
